┌─────────────────────────────────────────────────────────────┐
│                      Presentation Layer                      │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  abc.bvl.AdminTool.Api (ASP.NET Core Web API)         │ │
│  │  - Controllers (ScreenDefinition, ScreenPilot)         │ │
│  │  - Middleware (Security, Exception, RateLimit)         │ │
│  │  - Filters (EnrichResponse)                            │ │
│  │  - Validation (FluentValidation)                       │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                            ↓↑
┌─────────────────────────────────────────────────────────────┐
│                     Application Layer                        │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  abc.bvl.AdminTool.Application                         │ │
│  │  - CQRS Handlers (GetScreenDefinitions, etc.)          │ │
│  │  - MediatR pipeline                                    │ │
│  │  - Interfaces (IUnitOfWork, IRequestContext)           │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                            ↓↑
┌─────────────────────────────────────────────────────────────┐
│                       Domain Layer                           │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  abc.bvl.AdminTool.Domain (Pure Business Logic)        │ │
│  │  - Entities (ScreenDefinition, ScreenPilot, etc.)      │ │
│  │  - Base Classes (BaseAdminEntity, BaseLookupEntity)    │ │
│  │  - Business Rules & Validation                         │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                            ↓↑
┌─────────────────────────────────────────────────────────────┐
│                   Infrastructure Layer                       │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  abc.bvl.AdminTool.Infrastructure.Data                 │ │
│  │  - DbContext (EF Core for Oracle)                      │ │
│  │  - Repositories (Generic + Specific)                   │ │
│  │  - UnitOfWork Pattern                                  │ │
│  │  - Database Seeder                                     │ │
│  └────────────────────────────────────────────────────────┘ │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  abc.bvl.AdminTool.Infrastructure.Replication          │ │
│  │  - Outbox Pattern (Dual-DB sync)                       │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                            ↓↑
┌─────────────────────────────────────────────────────────────┐
│                      Contracts Layer                         │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  abc.bvl.AdminTool.Contracts                           │ │
│  │  - DTOs (ScreenDefnDto, CountryDto, etc.)              │ │
│  │  - Response Wrappers (ApiResponse, PagedResult)        │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                            ↓↑
                    ┌───────────────┐
                    │ Oracle DB     │
                    │ (XEPDB1)      │
                    └───────────────┘



                    1. HTTP Request
   ↓
   GET /api/v1/admin/screen-definition/screens?status=1&page=1&pageSize=20
   Headers: Authorization: Bearer <JWT_TOKEN>

2. Middleware Pipeline (Order Matters!)
   ↓
   ┌─────────────────────────────────────┐
   │ SecurityHeadersMiddleware           │ → Adds security headers (X-Frame-Options, CSP, etc.)
   └─────────────────────────────────────┘
   ↓
   ┌─────────────────────────────────────┐
   │ GlobalExceptionMiddleware           │ → Catches all exceptions, sanitizes errors
   └─────────────────────────────────────┘
   ↓
   ┌─────────────────────────────────────┐
   │ JWT Authentication Middleware       │ → Validates JWT token, extracts claims
   └─────────────────────────────────────┘
   ↓
   ┌─────────────────────────────────────┐
   │ Authorization Middleware            │ → Checks roles (Admin, ScreenManager)
   └─────────────────────────────────────┘

3. Controller (ScreenDefinitionController)
   ↓
   [Authorize(Roles = "Admin,ScreenManager")]
   public async Task<ActionResult<PagedResult<ScreenDefnDto>>> GetScreens(...)
   {
       // Create query
       var query = new GetScreenDefinitionsQuery 
       { 
           Status = status, 
           Page = page, 
           PageSize = pageSize 
       };
       
       // Send to MediatR
       var result = await _mediator.Send(query, cancellationToken);
       
       // Return OK with data
       return Ok(PagedSuccess(result.Items, result.TotalCount, page, pageSize));
   }

4. MediatR Pipeline
   ↓
   Dispatches query to handler

5. Application Layer (Query Handler)
   ↓
   public class GetScreenDefinitionsHandler : IRequestHandler<GetScreenDefinitionsQuery, ...>
   {
       public async Task<...> Handle(GetScreenDefinitionsQuery request, ...)
       {
           // Use repository to get data
           var result = await _repository.GetPagedScreenDefinitionsAsync(...);
           
           // Map to DTOs
           var dtos = result.Items.Select(MapToDto);
           
           return new PagedResult<ScreenDefnDto>(...);
       }
   }

6. Infrastructure Layer (Repository)
   ↓
   public class ScreenDefinitionRepository : IScreenDefinitionRepository
   {
       public async Task<PagedResult<ScreenDefinition>> GetPagedScreenDefinitionsAsync(...)
       {
           // EF Core query with compiled queries for performance
           var query = _context.ScreenDefinitions
               .Where(s => s.Status == status)
               .OrderBy(s => s.ScreenName);
           
           var total = await query.CountAsync();
           var items = await query.Skip((page - 1) * pageSize).Take(pageSize).ToListAsync();
           
           return new PagedResult<ScreenDefinition>(items, total, page, pageSize);
       }
   }

7. Database (Oracle)
   ↓
   SELECT SCREENDEFNID, SCREENNAME, DESCRIPTION, STATUS, ...
   FROM ADMIN.SCREENDEFN
   WHERE STATUS = 1
   ORDER BY SCREENNAME
   OFFSET 0 ROWS FETCH NEXT 20 ROWS ONLY

8. Response Filter (EnrichResponseFilter)
   ↓
   Automatically enriches response with:
   - UserInfo (UserId, DisplayName, Email from JWT claims)
   - AccessInfo (CanRead, CanWrite, Roles, DbRoute)
   - CorrelationId (from HttpContext.TraceIdentifier)
   - ServerTime (DateTimeOffset.UtcNow)

9. HTTP Response
   ↓
   200 OK
   {
       "items": [...],
       "totalCount": 50,
       "page": 1,
       "pageSize": 20,
       "totalPages": 3,
       "hasNextPage": true,
       "hasPreviousPage": false,
       "user": {
           "userId": "john.doe",
           "displayName": "John Doe",
           "email": "john@example.com"
       },
       "access": {
           "canRead": true,
           "canWrite": true,
           "roles": ["Admin"],
           "dbRoute": "primary"
       },
       "correlationId": "0HMVEK...",
       "serverTime": "2025-10-26T19:30:00Z"
   }


   Design Patterns Used
1. Clean Architecture (Onion Architecture)
Dependency Rule: Dependencies point inward (API → Application → Domain)
Domain has no dependencies
Application depends only on Domain
Infrastructure implements Application interfaces
API depends on Application (not Infrastructure directly)
2. CQRS (Command Query Responsibility Segregation)
Queries: Read operations via MediatR handlers (GetScreenDefinitionsQuery)
Commands: Write operations (future - UpdateScreenDefinitionCommand)
MediatR: Mediates between controllers and handlers
3. Repository Pattern
Generic Repository: GenericRepository<T> for common CRUD
Specific Repositories: ScreenDefinitionRepository for complex queries
Unit of Work: UnitOfWork for transaction management
4. Dependency Injection
All services registered in Program.cs
Constructor injection throughout
Scoped lifetimes for DB contexts
5. DTO Pattern (Data Transfer Objects)
Separation: Domain entities ≠ API contracts
Records: Immutable DTOs (CountryDto, ScreenDefnDto)
Mapping: Entity → DTO in handlers
6. Middleware Pipeline Pattern
Security: Headers, authentication, authorization
Exception Handling: Global exception middleware
Filters: Response enrichment via EnrichResponseFilter
7. Factory Pattern
UnitOfWorkFactory: Creates UnitOfWork instances
DbContextFactory: Creates appropriate DB context based on routing
8. Strategy Pattern
Dual-DB Routing: Primary/Secondary database selection via headers
RequestContext: Captures routing strategy from HTTP headers
9. Outbox Pattern
Transactional Outbox: Ensures eventual consistency between databases
Background Worker: Processes outbox messages asynchronously
10. Generic Programming
GenericRepository<T>: Type-safe CRUD for all entities
Compiled Queries: Performance optimization for common queries
Key Architectural Decisions
Aspect	Choice	Why
Database	Oracle XE with EF Core	Enterprise-grade, existing Oracle infrastructure
ORM	Entity Framework Core	Strong typing, LINQ, migrations
API Style	RESTful with JWT	Industry standard, stateless
Validation	FluentValidation	Separation of concerns, testable
Logging	Serilog	Structured logging, flexible sinks
Documentation	Swagger/OpenAPI	Auto-generated, interactive
Authentication	JWT Bearer Tokens	Stateless, scalable
Error Handling	Global middleware	Centralized, consistent, secure
Naming	UPPERCASE (Oracle)	Database standard compatibility
Testing	MSTest + FluentAssertions	Microsoft standard, readable assertions


Client → API → Controller → MediatR → Query Handler → Repository → EF Core → Oracle
                     ↓
          EnrichResponseFilter (adds user/access info)
                     ↓
                  Response


Client → API → Controller → Validation → MediatR → Command Handler → UnitOfWork → Repository → EF Core → Oracle
                                                                            ↓
                                                                      Outbox Message
                                                                            ↓
                                  